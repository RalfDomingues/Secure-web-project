<div class="row">
  <div class="col-12">
    <h1>Painel de Controle</h1>
    <p class="lead">Bem-vindo, <strong><%= username %></strong>!</p>
  </div>
</div>

<!-- Formul√°rio de Import via Caminho F√≠sico -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üì§ Importar Arquivo pelo Caminho (POC)</h5>
      </div>
      <div class="card-body">
        <form action="/import-by-path" method="POST">
          <!--------------------------------------------------------------------
          Prote√ß√£o CSRF (Cross-Site Request Forgery)
          --------------------------------------------------------------------
          O middleware csurf gera um token √∫nico por sess√£o.
          Esse token deve estar presente nos formul√°rios. Se n√£o estiver, a requisi√ß√£o √© barrada.
          Isso impede que outro site envie requisi√ß√µes em nome do usu√°rio. -->
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <div class="mb-3">
            <label for="clientPath" class="form-label">Caminho completo no servidor (Windows):</label>
            <input
              type="text"
              id="clientPath"
              name="clientPath"
              class="form-control"
              placeholder='Ex: C:\Users\<%= username %>\Downloads\teste.pdf'
              required
            >
            <div class="form-text">
              Informe o caminho absoluto no servidor (POC para demonstra√ß√£o de mitiga√ß√£o de Path Traversal).
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Descri√ß√£o (opcional):</label>
            <textarea id="description" name="description" class="form-control" rows="3"
              placeholder="Descreva o arquivo... (opcional)"></textarea>
          </div>

          
          <button type="submit" class="btn btn-primary w-100">Enviar Arquivo</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Busca de Arquivos -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">üîç Buscar Arquivos</h5>
      </div>
      <div class="card-body">
        <form action="/search" method="GET">
          <div class="mb-3">
            <label for="search" class="form-label">Buscar por nome ou descri√ß√£o:</label>
            <input type="text" id="search" name="q" class="form-control" placeholder="Digite sua busca...">
          </div>
          <button type="submit" class="btn btn-success w-100">Buscar</button>
        </form>
        <a href="/search" class="btn btn-link">Ver todos os arquivos</a>
      </div>
    </div>
  </div>
</div>

<!-- Lista de Arquivos -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">üìÅ Meus Arquivos</h5>
      </div>
      <div class="card-body">
        <% if (files && files.length> 0) { %>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Descri√ß√£o</th>
                  <th>Data</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                <% files.forEach(file=> { %>
                  <tr>
                    <td><%= file.original_name %></td>
                    <td>
                      <% if (file.description) { %>
                        <%= file.description %>
                      <% } else { %>-<% } %>
                    </td>
                    <td><%= new Date(file.created_at).toLocaleString('pt-BR') %></td>
                    <td>
                      <form action="/files/download" method="POST" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="id" value="<%= file.id %>">
                        <button class="btn btn-sm btn-primary">‚¨áÔ∏è Download</button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info">
            Voc√™ ainda n√£o enviou nenhum arquivo.
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Logs de Auditoria -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-warning">
        <h5 class="mb-0">üìã √öltimas Atividades</h5>
      </div>
      <div class="card-body">
        <% if (logs && logs.length> 0) { %>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Detalhes</th>
                  <th>IP</th>
                  <th>Data</th>
                </tr>
              </thead>
              <tbody>
                <% logs.slice(0, 10).forEach(log=> { %>
                  <tr>
                    <td><code><%= log.event_type %></code></td>
                    <td>
                      <small>
                        <pre style="white-space: pre-wrap; margin: 0;"><% if (typeof log.event_metadata === 'object') { %><%= JSON.stringify(log.event_metadata, null, 2) %><% } else { %><%= log.event_metadata || '-' %><% } %></pre>
                      </small>
                    </td>
                    <td><%= log.ip_addr || '-' %></td>
                    <td><%= new Date(log.created_at).toLocaleString('pt-BR') %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info">
            Nenhuma atividade registrada.
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Logout -->
<div class="row mt-4 mb-5">
  <div class="col-12 text-center">
    <form action="/logout" method="POST" class="d-inline">
      <!--------------------------------------------------------------------
      Prote√ß√£o CSRF (Cross-Site Request Forgery)
      --------------------------------------------------------------------
      O middleware csurf gera um token √∫nico por sess√£o.
      Esse token deve estar presente nos formul√°rios. Se n√£o estiver, a requisi√ß√£o √© barrada.
      Isso impede que outro site envie requisi√ß√µes em nome do usu√°rio.-->
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button type="submit" class="btn btn-danger">üö™ Sair</button>
    </form>
  </div>
</div>
